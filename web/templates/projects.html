{% extends "base.html" %}

{% block title %}Projects - Masterlist{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-4 fw-bold">All Projects</h1>
        <p class="lead text-muted">Browse and filter through all project ideas</p>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-3">Filters</h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="categoryFilter">
                            <option value="">All Categories</option>
                            <option value="ai-ml">AI/ML</option>
                            <option value="design-tools">Design Tools</option>
                            <option value="productivity">Productivity</option>
                            <option value="browser-web">Browser/Web</option>
                            <option value="crypto-blockchain">Crypto/Blockchain</option>
                            <option value="development-tools">Development Tools</option>
                            <option value="content-writing">Content Writing</option>
                            <option value="e-commerce">E-Commerce</option>
                            <option value="education">Education</option>
                            <option value="health-fitness">Health/Fitness</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">Platform</label>
                        <select class="form-select" id="platformFilter">
                            <option value="">All Platforms</option>
                            <option value="figma-plugin">Figma Plugin</option>
                            <option value="chrome-extension">Chrome Extension</option>
                            <option value="vscode-extension">VSCode Extension</option>
                            <option value="web-app">Web App</option>
                            <option value="mobile-app">Mobile App</option>
                            <option value="saas-platform">SaaS Platform</option>
                            <option value="ai-browser-tools">AI Browser Tools</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">Min Quality Score</label>
                        <input type="range" class="form-range" id="qualityFilter" min="0" max="10" value="0" step="0.5">
                        <small class="text-muted">Score: <span id="qualityValue">0</span>/10</small>
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">Search</label>
                        <div class="search-box">
                            <i class="bi bi-search"></i>
                            <input type="text" class="form-control" id="searchFilter" placeholder="Search projects...">
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="applyFilters()">
                        <i class="bi bi-filter"></i> Apply Filters
                    </button>
                    <button class="btn btn-outline-secondary" onclick="resetFilters()">
                        <i class="bi bi-x-circle"></i> Reset
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Summary -->
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span class="text-muted">Showing <span id="resultCount">0</span> projects</span>
            </div>
            <div>
                <select class="form-select form-select-sm" id="sortBy" style="width: auto;">
                    <option value="quality">Sort by Quality</option>
                    <option value="name">Sort by Name</option>
                    <option value="category">Sort by Category</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Projects List -->
<div class="row" id="projectsList">
    <!-- Projects will be loaded here -->
</div>

<!-- Pagination -->
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center" id="pagination">
        <!-- Pagination will be loaded here -->
    </ul>
</nav>

<!-- Project Modal -->
<div class="modal fade" id="projectModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalProjectName"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalProjectContent">
                <!-- Project details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let currentFilters = {};

// Load projects on page load
$(document).ready(function() {
    loadProjects();
    
    // Update quality value display
    $('#qualityFilter').on('input', function() {
        $('#qualityValue').text($(this).val());
    });
    
    // Sort change
    $('#sortBy').on('change', function() {
        loadProjects();
    });
});

function applyFilters() {
    currentPage = 1;
    loadProjects();
}

function resetFilters() {
    $('#categoryFilter').val('');
    $('#platformFilter').val('');
    $('#qualityFilter').val(0);
    $('#qualityValue').text('0');
    $('#searchFilter').val('');
    currentPage = 1;
    loadProjects();
}

function loadProjects(page = 1) {
    showLoading();
    currentPage = page;
    
    // Get filter values
    const filters = {
        category: $('#categoryFilter').val(),
        platform: $('#platformFilter').val(),
        min_quality: $('#qualityFilter').val(),
        q: $('#searchFilter').val(),
        page: page,
        per_page: 12
    };
    
    // Remove empty filters
    Object.keys(filters).forEach(key => {
        if (!filters[key]) delete filters[key];
    });
    
    $.ajax({
        url: '/api/projects',
        data: filters,
        success: function(response) {
            displayProjects(response.projects);
            updatePagination(response.page, response.total_pages);
            $('#resultCount').text(response.total);
            hideLoading();
        },
        error: function() {
            hideLoading();
            alert('Error loading projects');
        }
    });
}

function displayProjects(projects) {
    const container = $('#projectsList');
    container.empty();
    
    if (projects.length === 0) {
        container.html(`
            <div class="col-12 text-center py-5">
                <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-3">No projects found matching your criteria</p>
            </div>
        `);
        return;
    }
    
    projects.forEach(project => {
        const qualityClass = getQualityBadgeClass(project.quality_score);
        const platforms = project.platforms.map(p => `<small class="text-muted">${p}</small>`).join(' | ');
        const tags = project.tags.slice(0, 3).map(tag => `<span class="tag-badge">${tag}</span>`).join('');
        
        const card = `
            <div class="col-md-6 col-lg-4">
                <div class="project-card h-100" onclick="showProjectDetails('${project.key}')" style="cursor: pointer;">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="h6 mb-0">${project.name}</h5>
                        <span class="quality-badge ${qualityClass}">${project.quality_score}/10</span>
                    </div>
                    
                    <p class="text-muted small mb-2">${project.category} | ${platforms}</p>
                    
                    <p class="text-muted small mb-3">
                        ${project.problem_statement ? project.problem_statement.substring(0, 100) + '...' : ''}
                    </p>
                    
                    <div class="mt-auto">
                        ${tags}
                        ${project.tags.length > 3 ? `<small class="text-muted">+${project.tags.length - 3} more</small>` : ''}
                    </div>
                </div>
            </div>
        `;
        
        container.append(card);
    });
}

function updatePagination(current, total) {
    const pagination = $('#pagination');
    pagination.empty();
    
    if (total <= 1) return;
    
    // Previous button
    pagination.append(`
        <li class="page-item ${current === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadProjects(${current - 1}); return false;">Previous</a>
        </li>
    `);
    
    // Page numbers
    for (let i = 1; i <= Math.min(total, 5); i++) {
        pagination.append(`
            <li class="page-item ${i === current ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadProjects(${i}); return false;">${i}</a>
            </li>
        `);
    }
    
    // Next button
    pagination.append(`
        <li class="page-item ${current === total ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadProjects(${current + 1}); return false;">Next</a>
        </li>
    `);
}

function showProjectDetails(projectKey) {
    showLoading();
    
    $.ajax({
        url: `/api/project/${projectKey}`,
        success: function(project) {
            $('#modalProjectName').text(project.name);
            
            const features = project.key_features ? project.key_features.map(f => `<li>${f}</li>`).join('') : '';
            const tags = project.tags.map(tag => `<span class="tag-badge">${tag}</span>`).join('');
            const similar = project.similar ? project.similar.map(s => 
                `<li><a href="#" onclick="showProjectDetails('${s.key}'); return false;">${s.name}</a> (${s.quality_score}/10)</li>`
            ).join('') : '';
            
            const content = `
                <div class="row">
                    <div class="col-md-8">
                        <h6>Problem Statement</h6>
                        <p>${project.problem_statement || 'N/A'}</p>
                        
                        <h6>Solution</h6>
                        <p>${project.solution_description || 'N/A'}</p>
                        
                        <h6>Key Features</h6>
                        <ul>${features || '<li>No features listed</li>'}</ul>
                        
                        <h6>Target Users</h6>
                        <p>${project.target_users || 'N/A'}</p>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="mb-3">
                            <h6>Details</h6>
                            <small class="text-muted">Category:</small> ${project.category}<br>
                            <small class="text-muted">Platforms:</small> ${project.platforms.join(', ')}<br>
                            <small class="text-muted">Quality Score:</small> ${project.quality_score}/10<br>
                            <small class="text-muted">Complexity:</small> ${project.technical_complexity}<br>
                            <small class="text-muted">Dev Time:</small> ${project.development_time}<br>
                            <small class="text-muted">Competition:</small> ${project.competition_level}
                        </div>
                        
                        <div class="mb-3">
                            <h6>Revenue Model</h6>
                            <p class="small">${project.revenue_model || 'N/A'}</p>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Tags</h6>
                            ${tags}
                        </div>
                        
                        ${similar ? `
                        <div>
                            <h6>Similar Projects</h6>
                            <ul class="small">${similar}</ul>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            $('#modalProjectContent').html(content);
            $('#projectModal').modal('show');
            hideLoading();
        },
        error: function() {
            hideLoading();
            alert('Error loading project details');
        }
    });
}
</script>
{% endblock %}