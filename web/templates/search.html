{% extends "base.html" %}

{% block title %}Advanced Search - Masterlist{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-4 fw-bold">Advanced Search</h1>
        <p class="lead text-muted">Find projects using smart tags and filters</p>
    </div>
</div>

<!-- Search Interface -->
<div class="row">
    <div class="col-md-4">
        <!-- Tag Selection -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Select Tags</h5>
            </div>
            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                <div id="tagCategories">
                    <!-- Tags will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Search Options -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Search Options</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Minimum Quality Score</label>
                    <input type="range" class="form-range" id="minQuality" min="0" max="10" value="0" step="0.5">
                    <small class="text-muted">Score: <span id="qualityValue">0</span>/10</small>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Maximum Complexity</label>
                    <input type="range" class="form-range" id="maxComplexity" min="1" max="10" value="10" step="1">
                    <small class="text-muted">Complexity: <span id="complexityValue">10</span>/10</small>
                </div>
                
                <button class="btn btn-primary w-100" onclick="performSearch()">
                    <i class="bi bi-search"></i> Search Projects
                </button>
                
                <button class="btn btn-outline-secondary w-100 mt-2" onclick="clearSearch()">
                    <i class="bi bi-x-circle"></i> Clear All
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <!-- Selected Tags -->
        <div class="card mb-3">
            <div class="card-body">
                <h6 class="mb-2">Selected Tags</h6>
                <div id="selectedTags">
                    <p class="text-muted">No tags selected</p>
                </div>
            </div>
        </div>
        
        <!-- Quick Searches -->
        <div class="card mb-3">
            <div class="card-body">
                <h6 class="mb-2">Quick Searches</h6>
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="quickSearch(['ai-powered', 'high-revenue'])">
                        <i class="bi bi-lightning"></i> AI + High Revenue
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="quickSearch(['quick-win', 'beginner-friendly'])">
                        <i class="bi bi-rocket"></i> Quick Wins for Beginners
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="quickSearch(['blockchain', 'crypto-browser-tools'])">
                        <i class="bi bi-currency-bitcoin"></i> Blockchain Projects
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="quickSearch(['design-focused', 'platform-figma-plugin'])">
                        <i class="bi bi-palette"></i> Design Tools
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="quickSearch(['productivity', 'automation'])">
                        <i class="bi bi-gear"></i> Productivity & Automation
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Search Results -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Search Results <span id="resultCount" class="badge bg-primary ms-2">0</span></h5>
            </div>
            <div class="card-body" id="searchResults" style="max-height: 600px; overflow-y: auto;">
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-search" style="font-size: 3rem;"></i>
                    <p class="mt-3">Select tags and click "Search Projects" to see results</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedIncludeTags = [];
let selectedExcludeTags = [];
let availableTags = {};

// Load tags on page load
$(document).ready(function() {
    loadTags();
    
    // Update slider values
    $('#minQuality').on('input', function() {
        $('#qualityValue').text($(this).val());
    });
    
    $('#maxComplexity').on('input', function() {
        $('#complexityValue').text($(this).val());
    });
});

function loadTags() {
    $.ajax({
        url: '/api/tags',
        success: function(tags) {
            availableTags = tags;
            displayTags(tags);
        }
    });
}

function displayTags(tags) {
    const container = $('#tagCategories');
    container.empty();
    
    const categoryNames = {
        'difficulty': 'Difficulty',
        'revenue': 'Revenue Potential',
        'timeline': 'Development Timeline',
        'quality': 'Quality Rating',
        'technology': 'Technology',
        'business': 'Business Model',
        'category': 'Project Category',
        'platform': 'Platform',
        'other': 'Other Tags'
    };
    
    Object.keys(tags).forEach(category => {
        if (tags[category].length === 0) return;
        
        const categoryHtml = `
            <div class="mb-3">
                <h6 class="text-muted mb-2">${categoryNames[category] || category}</h6>
                <div class="tag-group">
                    ${tags[category].map(tag => `
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="tag-${tag}" value="${tag}" onchange="toggleTag('${tag}')">
                            <label class="form-check-label small" for="tag-${tag}">${tag}</label>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        container.append(categoryHtml);
    });
}

function toggleTag(tag) {
    const checkbox = $(`#tag-${tag}`);
    const isChecked = checkbox.prop('checked');
    
    if (isChecked) {
        selectedIncludeTags.push(tag);
    } else {
        selectedIncludeTags = selectedIncludeTags.filter(t => t !== tag);
    }
    
    updateSelectedTags();
}

function updateSelectedTags() {
    const container = $('#selectedTags');
    
    if (selectedIncludeTags.length === 0) {
        container.html('<p class="text-muted">No tags selected</p>');
        return;
    }
    
    const tagsHtml = selectedIncludeTags.map(tag => 
        `<span class="tag-badge">${tag} <i class="bi bi-x" style="cursor: pointer;" onclick="removeTag('${tag}')"></i></span>`
    ).join('');
    
    container.html(tagsHtml);
}

function removeTag(tag) {
    selectedIncludeTags = selectedIncludeTags.filter(t => t !== tag);
    $(`#tag-${tag}`).prop('checked', false);
    updateSelectedTags();
}

function quickSearch(tags) {
    clearSearch();
    tags.forEach(tag => {
        $(`#tag-${tag}`).prop('checked', true);
        selectedIncludeTags.push(tag);
    });
    updateSelectedTags();
    performSearch();
}

function performSearch() {
    if (selectedIncludeTags.length === 0) {
        alert('Please select at least one tag');
        return;
    }
    
    showLoading();
    
    const params = {
        'include[]': selectedIncludeTags,
        'min_quality': $('#minQuality').val(),
        'max_complexity': $('#maxComplexity').val()
    };
    
    $.ajax({
        url: '/api/search',
        data: params,
        traditional: true,
        success: function(response) {
            displayResults(response.results);
            $('#resultCount').text(response.total);
            hideLoading();
        },
        error: function() {
            hideLoading();
            alert('Error performing search');
        }
    });
}

function displayResults(results) {
    const container = $('#searchResults');
    
    if (results.length === 0) {
        container.html(`
            <div class="text-center py-5 text-muted">
                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                <p class="mt-3">No projects found matching your criteria</p>
            </div>
        `);
        return;
    }
    
    const resultsHtml = results.map(project => {
        const qualityClass = getQualityBadgeClass(project.quality_score);
        const tags = project.tags.slice(0, 5).map(tag => `<span class="tag-badge small">${tag}</span>`).join('');
        
        return `
            <div class="border-bottom pb-3 mb-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            <a href="#" onclick="showProjectDetails('${project.key}'); return false;">${project.name}</a>
                        </h6>
                        <p class="text-muted small mb-2">${project.category} | ${project.platforms.join(', ')}</p>
                        <p class="small mb-2">${project.problem_statement}</p>
                        <div>${tags}</div>
                    </div>
                    <div class="ms-3">
                        <span class="quality-badge ${qualityClass}">${project.quality_score}/10</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.html(resultsHtml);
}

function clearSearch() {
    selectedIncludeTags = [];
    selectedExcludeTags = [];
    $('input[type="checkbox"]').prop('checked', false);
    $('#minQuality').val(0);
    $('#qualityValue').text('0');
    $('#maxComplexity').val(10);
    $('#complexityValue').text('10');
    updateSelectedTags();
    $('#searchResults').html(`
        <div class="text-center py-5 text-muted">
            <i class="bi bi-search" style="font-size: 3rem;"></i>
            <p class="mt-3">Select tags and click "Search Projects" to see results</p>
        </div>
    `);
    $('#resultCount').text('0');
}

// Use the same project details modal from projects page
function showProjectDetails(projectKey) {
    window.location.href = `/projects#${projectKey}`;
}
</script>
{% endblock %}