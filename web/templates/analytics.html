{% extends "base.html" %}

{% block title %}Analytics - Masterlist{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-4 fw-bold">Project Analytics</h1>
        <p class="lead text-muted">Comprehensive insights and trends analysis</p>
    </div>
</div>

<!-- Key Metrics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card text-center">
            <i class="bi bi-graph-up text-primary fs-1 mb-2"></i>
            <div class="stat-number">{{ stats.average_quality }}/10</div>
            <div class="stat-label">Average Quality</div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card text-center">
            <i class="bi bi-lightning text-warning fs-1 mb-2"></i>
            <div class="stat-number">{{ stats.quality_ranges['8-9'] + stats.quality_ranges['9-10'] }}</div>
            <div class="stat-label">High-Quality Projects</div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card text-center">
            <i class="bi bi-tags text-info fs-1 mb-2"></i>
            <div class="stat-number">{{ stats.total_tags }}</div>
            <div class="stat-label">Total Tags Applied</div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card text-center">
            <i class="bi bi-layers text-success fs-1 mb-2"></i>
            <div class="stat-number">{{ stats.platforms|length }}</div>
            <div class="stat-label">Platforms Covered</div>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="chart-container">
            <h3 class="h5 mb-3">Category Distribution</h3>
            <canvas id="categoryBarChart" height="300"></canvas>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="chart-container">
            <h3 class="h5 mb-3">Quality Distribution</h3>
            <canvas id="qualityPieChart" height="300"></canvas>
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="chart-container">
            <h3 class="h5 mb-3">Top 10 Platforms</h3>
            <canvas id="platformChart" height="350"></canvas>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="chart-container">
            <h3 class="h5 mb-3">Tag Usage Frequency</h3>
            <canvas id="tagChart" height="350"></canvas>
        </div>
    </div>
</div>

<!-- Insights -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Key Insights</h5>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li class="mb-2">
                        <strong>Quality Distribution:</strong> 
                        {{ ((stats.quality_ranges['8-9'] + stats.quality_ranges['9-10']) / stats.total_projects * 100)|round(1) }}% 
                        of projects score 8/10 or higher
                    </li>
                    <li class="mb-2">
                        <strong>Most Popular Category:</strong> 
                        {% set max_cat = stats.categories|dictsort(reverse=true, by='value')|first %}
                        {{ max_cat[0] }} with {{ max_cat[1] }} projects
                    </li>
                    <li class="mb-2">
                        <strong>Platform Diversity:</strong> 
                        Average of {{ (stats.total_projects / stats.platforms|length)|round(1) }} projects per platform
                    </li>
                    <li class="mb-2">
                        <strong>Tag Coverage:</strong> 
                        Average of {{ (stats.total_tags / stats.total_projects)|round(1) }} tags per project
                    </li>
                    <li>
                        <strong>Most Used Tag:</strong> 
                        {% if stats.top_tags %}{{ stats.top_tags[0][0] }} ({{ stats.top_tags[0][1] }} projects){% endif %}
                    </li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-trending-up"></i> Opportunities</h5>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li class="mb-2">
                        <strong>AI/ML Projects:</strong> Growing category with high revenue potential
                    </li>
                    <li class="mb-2">
                        <strong>Cross-Platform Solutions:</strong> Projects supporting multiple platforms show higher success rates
                    </li>
                    <li class="mb-2">
                        <strong>Quick Win Projects:</strong> 
                        {% set quick_wins = 0 %}
                        {% for tag, count in stats.top_tags %}
                            {% if tag == 'quick-win' %}{% set quick_wins = count %}{% endif %}
                        {% endfor %}
                        {{ quick_wins }} projects can be developed in â‰¤7 days
                    </li>
                    <li class="mb-2">
                        <strong>Underserved Platforms:</strong> Opportunities exist in less saturated platforms
                    </li>
                    <li>
                        <strong>Quality Gap:</strong> 
                        {{ stats.quality_ranges['0-5'] + stats.quality_ranges['5-6'] }} projects 
                        could benefit from improvements
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Export Options -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="mb-3">Export Analytics Data</h5>
                <div class="btn-group" role="group">
                    <a href="/api/export/json" class="btn btn-outline-primary">
                        <i class="bi bi-filetype-json"></i> Export JSON
                    </a>
                    <a href="/api/export/csv" class="btn btn-outline-primary">
                        <i class="bi bi-filetype-csv"></i> Export CSV
                    </a>
                    <button class="btn btn-outline-primary" onclick="window.print()">
                        <i class="bi bi-printer"></i> Print Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Category Bar Chart
const categoryData = {
    labels: [{% for cat, count in stats.categories.items() %}'{{ cat }}'{% if not loop.last %},{% endif %}{% endfor %}],
    datasets: [{
        label: 'Projects',
        data: [{% for cat, count in stats.categories.items() %}{{ count }}{% if not loop.last %},{% endif %}{% endfor %}],
        backgroundColor: '#2563eb',
        borderRadius: 6
    }]
};

new Chart(document.getElementById('categoryBarChart'), {
    type: 'bar',
    data: categoryData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Quality Pie Chart
const qualityData = {
    labels: ['Excellent (9-10)', 'Very Good (8-9)', 'Good (7-8)', 'Fair (6-7)', 'Needs Work (5-6)', 'Poor (0-5)'],
    datasets: [{
        data: [
            {{ stats.quality_ranges['9-10'] }},
            {{ stats.quality_ranges['8-9'] }},
            {{ stats.quality_ranges['7-8'] }},
            {{ stats.quality_ranges['6-7'] }},
            {{ stats.quality_ranges['5-6'] }},
            {{ stats.quality_ranges['0-5'] }}
        ],
        backgroundColor: [
            '#10b981', '#34d399', '#60a5fa', '#fbbf24', '#fb923c', '#ef4444'
        ]
    }]
};

new Chart(document.getElementById('qualityPieChart'), {
    type: 'doughnut',
    data: qualityData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Platform Chart (Top 10)
const platformSorted = Object.entries({
    {% for platform, count in stats.platforms.items() %}'{{ platform }}': {{ count }}{% if not loop.last %},{% endif %}{% endfor %}
}).sort((a, b) => b[1] - a[1]).slice(0, 10);

const platformData = {
    labels: platformSorted.map(p => p[0]),
    datasets: [{
        label: 'Projects',
        data: platformSorted.map(p => p[1]),
        backgroundColor: '#8b5cf6',
        borderRadius: 6
    }]
};

new Chart(document.getElementById('platformChart'), {
    type: 'horizontalBar',
    data: platformData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        scales: {
            x: {
                beginAtZero: true
            }
        }
    }
});

// Tag Usage Chart (Top 15)
const tagData = {
    labels: [{% for tag, count in stats.top_tags[:15] %}'{{ tag }}'{% if not loop.last %},{% endif %}{% endfor %}],
    datasets: [{
        label: 'Usage Count',
        data: [{% for tag, count in stats.top_tags[:15] %}{{ count }}{% if not loop.last %},{% endif %}{% endfor %}],
        backgroundColor: '#f59e0b',
        borderRadius: 6
    }]
};

new Chart(document.getElementById('tagChart'), {
    type: 'horizontalBar',
    data: tagData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        scales: {
            x: {
                beginAtZero: true
            }
        }
    }
});
</script>
{% endblock %}